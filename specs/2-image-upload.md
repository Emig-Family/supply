# Image upload package

https://github.com/emig-family/supply/issues/2

Short plan

Create a small, well-typed, reusable marketplace backend package (TypeScript) that can be consumed by this site and other Astro projects. Follow TDD: add failing tests first, implement minimal code to satisfy them, then iterate.

Design decisions (updated — proxy upload default)

- Default flow: Server-side proxy upload (server receives file, authenticates user, runs processing pipeline, then stores via adapter).  
- Language: TypeScript (publish compiled JS + types).  
- Module format: ESM build, target Node (primary) and Cloudflare Workers (adapter-only where feasible).  
- Core API: small, framework-agnostic surface exported from `@kwila-cloud/marketplace-backend`:
  - `upload(file: File | Buffer | Readable, opts): Promise<UploadResult>` — server-side API to accept uploads and run processing pipeline.
  - `getUrl(id, opts): string`
- Processing pipeline: core exposes a `Processor` interface and pipeline hooks; default processing (Node-only) is minimal: strip metadata and perform lossless compression. Optional Node-only processors (e.g., `@kwila-cloud/marketplace-backend/processor-node`) may implement additional steps using libraries like `sharp`.  
- Adapters: provide adapter interface and at least two adapters:
  - `local` adapter (filesystem) — good for local dev and CI tests
  - `r2` adapter (Cloudflare R2) — recommended for prod on Workers
  - (Future) `s3` adapter for broader compatibility
- Dependencies: keep core minimal and Worker-safe; allow Node-only optional dependencies (sharp) for processors.  


### PR: 1 - Tests: core API surface and proxy flow
- [ ] Add unit tests for `upload()` happy path (local adapter + processor stub).  
- [ ] Add unit tests for invalid inputs (missing file, unsupported mime).  
- [ ] Add tests for `getUrl()` behavior.  
- [ ] Add test scaffolding and CI config updates if needed.

### PR: 2 - Implement: core package minimal
- [ ] Implement core types and exported API (throwing `NotImplemented` errors where appropriate).  
- [ ] Implement simple `local` adapter that writes files to `./uploads` (used by tests).  
- [ ] Implement a `Processor` interface and a no-op processor used in tests.  
- [ ] Make tests from PR 1 pass with the local adapter and no-op processor.

### PR: 3 - Tests: processors and adapters
- [ ] Add unit tests for the `local` adapter (save, list, delete).  
- [ ] Add tests for the `Processor` contract (strip metadata, compress hooks).  
- [ ] Add adapter interface conformance tests (adapter must implement expected methods).

### PR: 4 - Implement: Node processor (optional) + R2 adapter
- [ ] Implement a Node-only processor helper (e.g., `processor-node`) that strips metadata and compresses images (may use `sharp`).  
- [ ] Implement Cloudflare R2 adapter (using Wrangler-compatible API).  
- [ ] Make processor and R2 adapter tests pass (R2 tests can be skipped in CI unless credentials are present).

### PR: 5 - Docs & publishing
- [ ] Add README with usage examples for Astro (server-side proxy) and guidance for direct uploads if desired.  
- [ ] Add package.json publishing metadata and build scripts (tsup/esbuild).  
- [ ] Add minimal example integration in `site/` (done as separate PR to the site repo).

Acceptance criteria

- Core package exposes a small, well-typed API consumable from Astro projects and server runtimes.  
- Tests exist and are green for core behaviors and local adapter with no-op processor.  
- Node-only processor implements stripping metadata and compression and is documented as optional.  
- R2 adapter is implemented and optionally exercised in integration tests when credentials are provided.  
- README explains usage for server-side proxy flow and notes about direct presign flows.

Notes / questions for interactive design

- Image processing will be server-side by default. Default processing: strip metadata and lossless compression.
- Authentication model: Token-based auth (Bearer tokens / API keys) — chosen for easiest integration with a static Astro site (works from client-side JS, no session state required).
- Token issuance model: API keys stored in Cloudflare D1 (database) with per-key metadata and revocation support. Server validates keys on upload requests. Key rotation and management handled via admin endpoints (out of scope for initial PR).
- D1 simulation for tests/dev: use a local SQLite instance (D1-compatible) for integration tests and local development. Provide migration scripts and an in-memory SQLite option for fast unit tests.
- Accepted file types and limits: accept `jpeg`, `png`, and `webp`; reject SVG. Maximum upload size: `10 MB` per file.

---

Generated by agent: updated spec for issue #2 (image upload).
